- hosts: all

  vars:
    girder_update: no
    girder_force: no
    girder_virtualenv: "{{ ansible_user_dir }}/.virtualenvs/girder"

    girder_worker_user: "worker"
    girder_worker_virtualenv: "/home/{{ girder_worker_user }}/.virtualenvs/girder-worker"
    girder_worker_plugins:
      - docker
      - girder_io

  pre_tasks:

    - name: Update package cache
      apt:
        update_cache: yes
      become: yes
      become_user: root

    - name: Install site specific packages
      apt:
        name: "{{ item }}"
      with_items:
        - acl
      become: yes
      become_user: root

    - name: Create Worker user
      user:
        name: "{{ girder_worker_user }}"
      become: yes
      become_user: root

  roles:
    - role: Stouts.mongodb
      become: yes
      become_user: root

    - role: girder.girder

    - role: SimpliField.rabbitmq
      become: yes
      become_user: root

    - role: angstwad.docker_ubuntu
      become: yes
      become_user: root

    - role: girder.worker
      girder_worker_install_source: "git"
      girder_worker_path: "/home/{{ girder_worker_user }}/girder_worker"
      become: yes
      become_user: "{{ girder_worker_user }}"

  post_tasks:
    - name: Add worker user to docker group
      user:
        shell: /bin/bash
        name: "{{ girder_worker_user }}"
        groups: docker
        append: yes
      become: yes

    - name: Restart docker daemon
      service:
        name: docker
        state: restarted
        enabled: yes
      become: yes

    - name: (Re)start girder_worker service to pick up Docker group addition
      service:
        name: girder_worker
        state: restarted
      become: yes
      become_user: root
      when: girder_worker_start

    - include: "post-tasks/girder.yml"
